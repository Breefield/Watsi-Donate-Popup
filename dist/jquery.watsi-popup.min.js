!function(a,b){function c(b,c){this.el=b,this.$el=a(b),this.options=a.extend({},e,c),this._defaults=e,this._name=d,this.init()}Array.prototype.randomElement=function(){return this[Math.floor(Math.random()*this.length)]};var d="watsiDonatePopup",e={propertyName:"value"};c.prototype={init:function(){this.popup_align=this.$el.attr("watsi-align")||this.options.align||"top",this.open_on_submit=this.$el.attr("watsi-submit-open")||this.options.submit_open||"no",this.buildPopupElement(),this.findOrInjectCSS(),this.loadPatients(),this.$el.on("change",a.proxy(function(){this.positionPopup(),this.$popup.toggleClass("open",this.$el.prop("checked"))},this))},buildPopupElement:function(){var b='<div class="watsi-popup" style="display: none"><span class="css-tester"></span><div class="info-bar section"><a href="https://watsi.org/" target="_blank"><img src="img/watsi-small.png" width="55"/></a><a class="more" href="https://watsi.org/" target="_blank">what is watsi?</a></div><div class="patient section cf"><h1 class="patient-title"></h1><img class="patient-photo" src=""/><p class="patient-summary"></p><a class="patient-more-link" href="" target="_blank">Donate</a></div></div>';this.$popup=a(b).insertAfter(this.$el),this.$popup.parent().css("position","relative"),this.$popup.addClass("align-"+this.popup_align)},findOrInjectCSS:function(){"red"!=this.$popup.find(".css-tester").css("background")?($css=a('<link href="https://s3.amazonaws.com/watsi-donate-popup/css/styles.css" media="all" rel="stylesheet" />').on("load",a.proxy(function(){this.$popup.css("display","block")},this)),a("body").append($css)):this.$popup.css("display","block")},loadPatients:function(){a.ajax("https://watsi-api-proxy.herokuapp.com/?url=https://watsi.org/fund-treatments.json",{dataType:"jsonp",success:a.proxy(function(a){this.current_profile=a.profiles.randomElement(),this.renderProfile(this.current_profile),this.positionPopup(),this.$popup.addClass("loaded")},this)})},renderProfile:function(b){this.$popup.find(".patient-title").text("Fund "+b.name+"'s Treatment"),this.$popup.find(".patient-photo").attr("src",b.profile_url),this.$popup.find(".patient-summary").text(b.promo_description),this.$popup.find(".patient-more-link").attr("href",b.url+"?from=popup"),this.$popup.find(".patient-more-link").on("click",a.proxy(function(){this.openWatsi()},this)),1==this.open_on_submit&&this.$el.parent("form").on("submit",a.proxy(function(){this.openWatsi()},this))},openWatsi:function(){console.log(this);var c={x:a(b).width()/2-492.5,y:150},d=b.open(this.current_profile.url,"","height=560,width=985,location=false,toolbar=false,menubar=false,screenX="+c.x+",screenY="+c.y+",left"+c.x+",top"+c.y);b.focus&&d.focus(),this.$popup.removeClass("open")},positionPopup:function(){var a=this.$el.position(),b=15;switch(this.popup_align){case"left":this.$popup.css({top:a.top+this.$el.outerHeight()/2-this.$popup.outerHeight()/2,left:a.left-b-this.$popup.outerWidth()});break;case"right":this.$popup.css({top:a.top+this.$el.outerHeight()/2-this.$popup.outerHeight()/2,left:a.left+this.$el.outerWidth()+b});break;case"bottom":this.$popup.css({top:a.top+this.$el.outerHeight()+b,left:a.left+this.$el.outerWidth()/2-this.$popup.outerWidth()/2});break;case"top":this.$popup.css({top:a.top-this.$popup.outerHeight()-b,left:a.left+this.$el.outerWidth()/2-this.$popup.outerWidth()/2})}}},a.fn[d]=function(b){return this.each(function(){a.data(this,"plugin_"+d)||a.data(this,"plugin_"+d,new c(this,b))})},a("[watsi-popup]").watsiDonatePopup()}(jQuery,window,document);